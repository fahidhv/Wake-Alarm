<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart 2 Alarm</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Link to the Web App Manifest -->
    <link rel="manifest" href="./manifest.json">
    <!-- Theme color for PWA -->
    <meta name="theme-color" content="#ffffff">
    <script>
        // Custom Tailwind theme settings
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* bg-slate-50 */
        }
        /* Simple modal transition */
        .modal {
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
        /* Day selector custom style */
        .day-toggle input:checked + label {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
            border-color: #2563eb; /* bg-blue-600 */
        }
        /* Toggle switch base */
        .toggle-switch {
            width: 44px; /* w-11 */
            height: 24px; /* h-6 */
        }
        /* Toggle switch nub */
        .toggle-nub {
            width: 20px; /* w-5 */
            height: 20px; /* h-5 */
            top: 2px; /* top-0.5 */
            left: 2px; /* left-[2px] */
            transition: all 0.2s ease-in-out;
        }
        input:checked + .toggle-switch {
            background-color: #2563eb; /* peer-checked:bg-blue-600 */
        }
        input:checked + .toggle-switch .toggle-nub {
            transform: translateX(20px); /* peer-checked:after:translate-x-full */
        }
    </style>
</head>
<body class="text-gray-900 min-h-screen">

    <!-- SVG Icon Definitions -->
    <svg id="svg-icons" xmlns="http://www.w3.org/2000/svg" class="hidden">
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </symbol>
        <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </symbol>
        <symbol id="icon-work" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </symbol>
        <symbol id="icon-volume-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </symbol>
        <symbol id="icon-more-vertical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="1"></circle>
            <circle cx="12" cy="5" r="1"></circle>
            <circle cx="12" cy="19" r="1"></circle>
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </symbol>
        <!-- New Icons -->
        <symbol id="icon-graduation-cap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
            <path d="M6 12v5c3.33 1 6.67 1 10 0v-5"></path>
        </symbol>
        <symbol id="icon-dumbbell" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M6.5 6.5a4.5 4.5 0 1 1-4 4"></path>
            <path d="M21.5 6.5a4.5 4.5 0 1 1-4 4"></path>
            <path d="M5 8h14"></path>
            <path d="M4 6.5A2.5 2.5 0 0 1 6.5 4h0A2.5 2.5 0 0 1 9 6.5v8A2.5 2.5 0 0 1 6.5 17h0A2.5 2.5 0 0 1 4 14.5v-8Z"></path>
            <path d="M15 6.5A2.5 2.5 0 0 1 17.5 4h0A2.5 2.5 0 0 1 20 6.5v8a2.5 2.5 0 0 1-2.5 2.5h0a2.5 2.5 0 0 1-2.5-2.5v-8Z"></path>
        </symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </symbol>
        <symbol id="icon-coffee" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
            <path d="M2 8h14v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
            <line x1="6" y1="1" x2="6" y2="4"></line>
            <line x1="10" y1="1" x2="10" y2="4"></line>
            <line x1="14" y1="1" x2="14" y2="4"></line>
        </symbol>
        <symbol id="icon-book" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </symbol>
        <symbol id="icon-game" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19.11 10.64s.27-.18.54-.42c.81-.73.81-1.89 0-2.61a1.83 1.83 0 0 0-2.6 0l-.41.36"></path>
            <path d="M10.26 19.58s.18.27.42.54c.73.81 1.89.81 2.61 0a1.83 1.83 0 0 0 0-2.6l-.36-.41"></path>
            <path d="M15 12v.01"></path><path d="M12 15v.01"></path>
            <path d="M4.89 13.36s-.27.18-.54.42c-.81.73-.81 1.89 0 2.61a1.83 1.83 0 0 0 2.6 0l.41-.36"></path>
            <path d="M13.74 4.42s-.18-.27-.42-.54c-.73-.81-1.89-.81-2.61 0a1.83 1.83 0 0 0 0 2.6l.36.41"></path>
            <path d="M3 12h3M9 12h3M3 9v3M9 9v3"></path>
            <rect width="20" height="14" x="2" y="5" rx="2"></rect>
        </symbol>
        <symbol id="icon-plane" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-1-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 5.7 5.7c.3.3.7.4 1.1.3l.5-.2c.4-.3.6-.7.5-1.2z"></path>
        </symbol>
        <symbol id="icon-pill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"></path>
            <path d="m8.5 8.5 7 7"></path>
        </symbol>
        <symbol id="icon-dog" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 5.2a2 2 0 0 1 2-2h.4a2 2 0 0 1 2 2v.6c0 .5-.2 1.1-.7 1.3l-2.1.8c-.5.2-1.1.2-1.6 0l-2.1-.8c-.4-.2-.7-.7-.7-1.3Z"></path>
            <path d="M5 14v-4.7a2 2 0 0 1 1-1.7l6-3.4a2 2 0 0 1 2 0l6 3.4a2 2 0 0 1 1 1.7V14"></path>
            <path d="M5 14v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2"></path>
            <path d="M5 14h14v-2c0-1.4-1.3-2.6-2.9-2.8l-1.3-.2a2 2 0 0 1-1.6-2V6.1A2 2 0 0 0 12.6 5c-.3 0-.6.1-.9.2"></path>
            <path d="M10 18v-2"></path><path d="M14 18v-2"></path>
        </symbol>
        <symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </symbol>
    </svg>

    <!-- Main Content Area -->
    <div id="app-container" class="max-w-2xl mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Smart Alarm</h1>
            <div class="flex items-center space-x-2">
                <button id="permission-btn" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-sm font-medium hidden hover:bg-blue-200">
                    Grant Permissions
                </button>
                <button id="settings-btn" class="p-2 text-gray-500 hover:text-gray-900" title="Settings">
                    <svg class="w-6 h-6"><use href="#icon-settings"></use></svg>
                </button>
            </div>
        </header>

        <!-- Main View (Groups) -->
        <div id="main-view">
            <!-- Group Header -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Your Groups</h2>
                <button id="batch-add-btn" class="flex items-center space-x-1 text-sm text-gray-600 hover:text-blue-600" title="Batch Create">
                    <svg class="w-4 h-4"><use href="#icon-clock"></use></svg>
                    <span>Batch Create</span>
                </button>
            </div>

            <!-- Alarm Groups Container -->
            <div id="group-list-container" class="space-y-3">
                <!-- Groups will be rendered here by JS -->
            </div>

            <!-- Add Group Button -->
            <button id="add-group-btn" class="mt-4 w-full flex items-center justify-center space-x-2 bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 p-3 rounded-xl shadow-sm font-medium text-center">
                <svg class="w-5 h-5"><use href="#icon-plus"></use></svg>
                <span>Create Custom Group</span>
            </button>
        </div>

    </div>

    <!-- Floating Action Button (Add Alarm) -->
    <button id="add-alarm-btn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg z-40" title="Add New Alarm">
        <svg class="w-8 h-8"><use href="#icon-plus"></use></svg>
    </button>


    <!-- ===== MODALS ===== -->

    <!-- Generic Modal for Group/Alarm/Batch Forms OR Alarm List -->
    <div id="form-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900">Modal Title</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- Alarm Ringing Modal -->
    <div id="ringing-modal" class="modal fixed inset-0 bg-white flex flex-col items-center justify-center p-8 hidden z-[100]">
        <div class="text-center">
            <p id="ringing-label" class="text-3xl font-bold text-gray-900 mb-4">Alarm Label</p>
            <p id="ringing-time" class="text-8xl font-thin text-blue-600 mb-12">00:00</p>
        </div>
        <button id="stop-alarm-btn" class="bg-red-600 hover:bg-red-700 text-white w-full max-w-xs py-6 rounded-lg text-3xl font-bold shadow-lg">
            STOP
        </button>
    </div>

    <!-- ===== JAVASCRIPT LOGIC ===== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE & CONSTANTS ---
            const STORAGE_KEY = 'smartAlarmApp';
            const DEFAULT_STATE = {
                groups: [
                    { id: 'g1', name: 'Home', isEnabled: true, ringtone: 'Digital', alarms: [], icon: 'icon-home' },
                    { id: 'g2', name: 'Work', isEnabled: true, ringtone: 'Chime', alarms: [], icon: 'icon-work' }
                ],
                globalSettings: {}
            };
            const RINGTONES = [
                { id: 'Digital', name: 'Digital', play: (synth) => synth.triggerAttackRelease("C6", "8n") },
                { id: 'Chime', name: 'Chime', play: (synth) => {
                    synth.triggerAttackRelease("C5", "8n", "+0");
                    synth.triggerAttackRelease("E5", "8n", "+0.2");
                    synth.triggerAttackRelease("G5", "8n", "+0.4");
                }},
                { id: 'Alarm', name: 'Alarm', play: (synth) => synth.triggerAttackRelease("A5", "4n") },
                { id: 'None', name: 'None', play: () => {} }
            ];
            const DAYS_OF_WEEK = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            let appState = loadState();
            let currentRingingAlarm = null;
            let currentRingtoneLoop = null;
            let alarmCheckInterval = null;
            let currentStopTimeout = null;
            let currentView = 'groups'; // Track current view
            let currentGroupId = null; // Track viewed group

            // --- DOM ELEMENTS ---
            const groupListContainer = document.getElementById('group-list-container');
            const permissionBtn = document.getElementById('permission-btn');
            const settingsBtn = document.getElementById('settings-btn'); // Get settings button
            const modal = document.getElementById('form-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const ringingModal = document.getElementById('ringing-modal');
            const addAlarmBtn = document.getElementById('add-alarm-btn');
            const addGroupBtn = document.getElementById('add-group-btn');
            const batchAddBtn = document.getElementById('batch-add-btn');

            // --- INITIALIZATION ---
            function initialize() {
                registerServiceWorker(); 
                checkNotificationPermission();
                
                if (alarmCheckInterval) clearInterval(alarmCheckInterval);
                alarmCheckInterval = setInterval(checkAlarms, 10000); // Check every 10 seconds
                checkAlarms(); // Check immediately on load

                renderAll();
                attachGlobalListeners();
                
                // Send alarms to SW on initial load
                sendAlarmsToServiceWorker();
            }

            // --- PWA & NOTIFICATIONS ---
            function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('./service-worker.js')
                            .then(reg => {
                                console.log('Service Worker registered.', reg);
                                // Listen for a new worker installing
                                reg.addEventListener('updatefound', () => {
                                    const newWorker = reg.installing;
                                    newWorker.addEventListener('statechange', () => {
                                        if (newWorker.state === 'activated') {
                                            // A new SW has activated, send it the latest alarms
                                            sendAlarmsToServiceWorker();
                                        }
                                    });
                                });
                            })
                            .catch(err => console.error('Service Worker registration failed:', err));
                    });
                } else {
                    console.log('Service Worker not supported in this browser.');
                }
            }

            function checkNotificationPermission() {
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        permissionBtn.classList.remove('hidden');
                    } else if (Notification.permission === 'denied') {
                        permissionBtn.classList.remove('hidden');
                        permissionBtn.textContent = 'Permissions Denied';
                        permissionBtn.disabled = true;
                    }
                }
            }

            function requestNotificationPermission() {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        permissionBtn.classList.add('hidden');
                    } else {
                        permissionBtn.textContent = 'Permission Denied';
                    }
                });
            }

            function sendAlarmsToServiceWorker() {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'UPDATE_ALARMS',
                        alarms: appState.groups
                    });
                } else {
                    // This can happen on first load or if SW is not active
                    console.log('Service Worker not yet ready, alarms will be sent when it becomes active.');
                    // Retry after a short delay
                    setTimeout(sendAlarmsToServiceWorker, 1000);
                }
            }

            // --- STATE MANAGEMENT ---
            function loadState() {
                try {
                    const state = localStorage.getItem(STORAGE_KEY);
                    if (state) {
                        const parsed = JSON.parse(state);
                        if (parsed && parsed.groups) {
                            return parsed;
                        }
                    }
                } catch (e) {
                    console.error("Failed to load or parse state, reverting to default.", e);
                }
                return JSON.parse(JSON.stringify(DEFAULT_STATE));
            }

            function saveState() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
                
                if (currentView === 'groups') {
                    renderGroups();
                } else if (currentView === 'alarms' && currentGroupId) {
                    showGroupAlarms(currentGroupId);
                } else {
                    renderAll(); // Fallback
                }
                sendAlarmsToServiceWorker();
            }

            // --- RENDER FUNCTIONS ---
            function renderAll() {
                renderGroups();
            }

            function renderGroups() {
                groupListContainer.innerHTML = '';
                if (appState.groups.length === 0) {
                    groupListContainer.innerHTML = `<p class="text-gray-500 text-center py-10">No groups created yet.</p>`;
                }

                appState.groups.forEach(group => {
                    const groupEl = document.createElement('div');
                    const ringtone = RINGTONES.find(r => r.id === group.ringtone);
                    const ringtoneName = (ringtone && ringtone.name) ? ringtone.name : 'Default';
                    const alarmCount = (group.alarms && group.alarms.length) ? group.alarms.length : 0;
                    const groupIcon = group.icon ? `#${group.icon}` : '#icon-settings';

                    groupEl.className = `bg-white rounded-xl shadow-sm p-4 transition-all ${group.isEnabled ? '' : 'opacity-60'}`;
                    
                    groupEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="group-card-clickable flex-1 flex items-center space-x-3 min-w-0 cursor-pointer" data-group-id="${group.id}">
                                <div class="p-3 bg-blue-100 text-blue-600 rounded-full">
                                    <svg class="w-6 h-6"><use href="${groupIcon}"></use></svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-lg font-semibold text-gray-900 truncate">${group.name}</p>
                                    <div class="flex items-center space-x-1 text-gray-500 text-sm">
                                        <svg class="w-4 h-4"><use href="#icon-volume-2"></use></svg>
                                        <span>${ringtoneName}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer toggle-group-btn" data-group-id="${group.id}" ${group.isEnabled ? 'checked' : ''}>
                                    <div class="toggle-switch bg-gray-200 rounded-full relative">
                                        <div class="toggle-nub bg-white border-gray-300 border rounded-full absolute"></div>
                                    </div>
                                </label>
                                <button class="edit-group-btn p-1 text-gray-500 hover:text-gray-900" data-group-id="${group.id}" title="Edit Group">
                                    <svg class="w-5 h-5"><use href="#icon-more-vertical"></use></svg>
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between items-center pl-16">
                            <div></div>
                            <span class="text-sm font-medium ${alarmCount > 0 ? 'text-blue-700 bg-blue-100' : 'text-gray-600 bg-gray-100'} px-2.5 py-0.5 rounded-full">
                                ${alarmCount} ${alarmCount === 1 ? 'alarm' : 'alarms'}
                            </span>
                        </div>
                    `;
                    groupListContainer.appendChild(groupEl);
                });
            }

            function getDaysString(days) {
                if (!days || days.length === 0) return 'Once';
                if (days.length === 7) return 'Every day';
                if (days.length === 2 && days.includes('Sat') && days.includes('Sun')) return 'Weekends';
                if (days.length === 5 && !days.includes('Sat') && !days.includes('Sun')) return 'Weekdays';
                return days.join(', ');
            }
            
            // --- MODAL & FORM LOGIC ---
            function openModal(title, formHtml) {
                modalTitle.textContent = title;
                modalBody.innerHTML = formHtml;
                modal.classList.remove('hidden');
            }

            function closeModal() {
                modal.classList.add('hidden');
                modalBody.innerHTML = '';
                currentView = 'groups'; // Reset view state
                currentGroupId = null; // Reset group ID
            }

            function createRingtoneSelect(selected) {
                return RINGTONES.map(r => `<option value="${r.id}" ${r.id === selected ? 'selected' : ''}>${r.name}</option>`).join('');
            }

            function createGroupSelect(selected) {
                return appState.groups.map(g => `<option value="${g.id}" ${g.id === selected ? 'selected' : ''}>${g.name}</option>`).join('');
            }

            function createDayToggles(selectedDays = []) {
                return DAYS_OF_WEEK.map((day, index) => `
                    <div class="day-toggle">
                        <input type="checkbox" id="day-${day}" name="days" value="${day}" class="sr-only" ${selectedDays.includes(day) ? 'checked' : ''}>
                        <label for="day-${day}" class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-gray-300 cursor-pointer text-gray-500 font-medium transition-colors">
                            ${day.substring(0, 1)}
                        </label>
                    </div>
                `).join('');
            }

            function showGroupForm(group = null) {
                currentView = 'form';
                const isEditing = !!group;
                const selectedIcon = (group && group.icon) ? group.icon : 'icon-home';

                const ICONS = [
                    'icon-home', 'icon-work', 'icon-graduation-cap', 'icon-dumbbell', 'icon-moon', 'icon-sun',
                    'icon-coffee', 'icon-book', 'icon-game', 'icon-plane', 'icon-pill', 'icon-dog'
                ];

                const iconButtons = ICONS.map(iconId => `
                    <button type="button" class="icon-select-btn p-3 rounded-lg border-2 ${selectedIcon === iconId ? 'bg-blue-100 border-blue-600 text-blue-600' : 'border-gray-200 bg-white text-gray-500 hover:bg-gray-50'}" data-icon="${iconId}">
                        <svg class="w-6 h-6"><use href="#${iconId}"></use></svg>
                    </button>
                `).join('');

                const formHtml = `
                    <form id="group-form" class="space-y-4">
                        <input type="hidden" name="id" value="${(group && group.id) ? group.id : ''}">
                        <input type="hidden" id="group-icon-input" name="icon" value="${selectedIcon}">
                        
                        <div>
                            <label for="group-name" class="block text-sm font-medium text-gray-700 mb-1">Group Name</label>
                            <input type="text" id="group-name" name="name" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="${(group && group.name) ? group.name : ''}" placeholder="e.g., Morning Routine" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                            <div id="icon-grid" class="grid grid-cols-6 gap-2">
                                ${iconButtons}
                            </div>
                        </div>

                        <div>
                            <label for="group-ringtone" class="block text-sm font-medium text-gray-700 mb-1">Default Ringtone</label>
                            <select id="group-ringtone" name="ringtone" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                                ${createRingtoneSelect((group && group.ringtone) ? group.ringtone : 'Digital')}
                            </select>
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 space-x-2">
                            <button type="button" id="form-cancel-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium">Cancel</button>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">${isEditing ? 'Save' : 'Create'}</button>
                        </div>
                        
                        ${isEditing ? `
                        <div class="pt-2 text-center">
                            <button type="button" id="delete-group-btn" class="text-red-600 hover:text-red-800 font-medium">Delete Group</button>
                        </div>
                        ` : ''}
                    </form>
                `;
                openModal(isEditing ? 'Edit Group' : 'Create Group', formHtml);
            }

            function showAlarmForm(alarm = null, groupId = null) {
                currentView = 'form';
                const isEditing = !!alarm;
                const alarmGroupId = (alarm && alarm.groupId) ? alarm.groupId : (groupId || currentGroupId || (appState.groups[0] && appState.groups[0].id) || '');

                const formHtml = `
                    <form id="alarm-form" class="space-y-4">
                        <input type="hidden" name="id" value="${(alarm && alarm.id) ? alarm.id : ''}">
                        <input type="hidden" name="originalGroupId" value="${alarmGroupId}">
                        <div>
                            <label for="alarm-group" class="block text-sm font-medium text-gray-700 mb-1">Group</label>
                            <select id="alarm-group" name="groupId" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" required>
                                ${appState.groups.length > 0 ? createGroupSelect(alarmGroupId) : '<option>Please create a group first</option>'}
                            </select>
                        </div>
                        <div>
                            <label for="alarm-time" class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <input type="time" id="alarm-time" name="time" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="${(alarm && alarm.time) ? alarm.time : '07:00'}" required>
                        </div>
                        <div>
                            <label for="alarm-label" class="block text-sm font-medium text-gray-700 mb-1">Label</label>
                            <input type="text" id="alarm-label" name="label" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="${(alarm && alarm.label) ? alarm.label : ''}" placeholder="e.g., Wake up">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Repeat</label>
                            <div class="flex justify-around">
                                ${createDayToggles(alarm && alarm.days)}
                            </div>
                        </div>
                        <div>
                            <label for="alarm-ringtone" class="block text-sm font-medium text-gray-700 mb-1">Ringtone (Overrides group)</label>
                            <select id="alarm-ringtone" name="ringtone" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900">
                                <option value="">Use Group Default</option>
                                ${createRingtoneSelect(alarm && alarm.ringtone)}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="alarm-duration" class="block text-sm font-medium text-gray-700 mb-1">Ring Duration (seconds)</label>
                                <input type="number" id="alarm-duration" name="duration" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="${(alarm && alarm.duration) ? alarm.duration : 60}" placeholder="60">
                            </div>
                            <div>
                                <label for="alarm-color" class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                                <input type="color" id="alarm-color" name="color" class="w-full h-10 bg-gray-100 border border-gray-300 rounded-lg" value="${(alarm && alarm.color) ? alarm.color : '#1f2937'}">
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            ${isEditing ? `<button type="button" id="delete-alarm-btn" class="text-red-600 hover:text-red-800 font-medium">Delete Alarm</button>` : '<div></div>'}
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium" ${appState.groups.length === 0 ? 'disabled' : ''}>${isEditing ? 'Save Changes' : 'Create Alarm'}</button>
                        </div>
                    </form>
                `;
                openModal(isEditing ? 'Edit Alarm' : 'Add New Alarm', formHtml);
            }

            function showBatchForm() {
                currentView = 'form';
                const formHtml = `
                    <form id="batch-form" class="space-y-4">
                        <div>
                            <label for="batch-group" class="block text-sm font-medium text-gray-700 mb-1">Group</label>
                            <select id="batch-group" name="groupId" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" required>
                                ${appState.groups.length > 0 ? createGroupSelect(currentGroupId) : '<option>Please create a group first</option>'}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="batch-start" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                <input type="time" id="batch-start" name="start" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="09:00" required>
                            </div>
                            <div>
                                <label for="batch-end" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                <input type="time" id="batch-end" name="end" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="17:00" required>
                            </div>
                        </div>
                        <div>
                            <label for="batch-interval" class="block text-sm font-medium text-gray-700 mb-1">Interval (minutes)</label>
                            <input type="number" id="batch-interval" name="interval" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" value="60" min="1" required>
                        </div>
                        <div>
                            <label for="batch-label" class="block text-sm font-medium text-gray-700 mb-1">Label Prefix</label>
                            <input type="text" id="batch-label" name="label" class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-gray-900" placeholder="e.g., Break">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Days</label>
                            <div class="flex justify-around">
                                ${createDayToggles(['Mon', 'Tue', 'Wed', 'Thu', 'Fri'])}
                            </div>
                        </div>
                        <div class="flex justify-end pt-2">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium" ${appState.groups.length === 0 ? 'disabled' : ''}>Create Batch</button>
                        </div>
                    </form>
                `;
                openModal('Batch Add Alarms', formHtml);
            }

            // --- Show Alarms in Group ---
            function showGroupAlarms(groupId) {
                const group = appState.groups.find(g => g.id === groupId);
                if (!group) return;

                currentView = 'alarms';
                currentGroupId = groupId;

                let alarmHtml = '';
                if (!group.alarms || group.alarms.length === 0) {
                    alarmHtml = '<p class="text-gray-500 text-center py-4">No alarms in this group.</p>';
                } else {
                    const sortedAlarms = [...group.alarms].sort((a, b) => a.time.localeCompare(b.time));

                    alarmHtml = sortedAlarms.map(alarm => `
                        <div class="alarm-item-clickable flex items-center py-3 border-b border-gray-200 last:border-b-0" data-alarm-id="${alarm.id}">
                            <div class="flex-1 min-w-0 cursor-pointer" data-alarm-id="${alarm.id}">
                                <p class="text-2xl font-medium text-gray-900 ${alarm.isEnabled ? '' : 'text-gray-400 line-through'}">${alarm.time}</p>
                                <p class="text-sm text-gray-600 truncate ${alarm.isEnabled ? '' : 'text-gray-400 line-through'}">
                                    ${alarm.label || 'Alarm'} | ${getDaysString(alarm.days)}
                                </p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="sr-only peer toggle-alarm-btn" data-alarm-id="${alarm.id}" data-group-id="${group.id}" ${alarm.isEnabled ? 'checked' : ''}>
                                <div class="toggle-switch bg-gray-200 rounded-full relative">
                                    <div class="toggle-nub bg-white border-gray-300 border rounded-full absolute"></div>
                                </div>
                            </label>
                        </div>
                    `).join('');
                }

                const modalContentHtml = `
                    <div class="space-y-2">
                        <button id="modal-back-btn" class="flex items-center text-sm text-blue-600 hover:text-blue-800 font-medium mb-2">
                            <svg class="w-5 h-5 mr-1"><use href="#icon-chevron-left"></use></svg>
                            Back to Groups
                        </button>
                        ${alarmHtml}
                    </div>
                `;
                openModal(group.name, modalContentHtml);
            }

            // --- EVENT HANDLERS ---
            function attachGlobalListeners() {
                try {
                    permissionBtn.addEventListener('click', requestNotificationPermission);
                    modalCloseBtn.addEventListener('click', closeModal);
                    
                    addGroupBtn.addEventListener('click', () => showGroupForm());
                    addAlarmBtn.addEventListener('click', () => showAlarmForm(null, currentGroupId));
                    batchAddBtn.addEventListener('click', () => showBatchForm());
                    
                    // *** FIX ***: Added listener for settings button
                    settingsBtn.addEventListener('click', () => {
                        const settingsHtml = `
                            <p class="text-gray-700">Settings are not yet implemented.</p>
                            <p class="text-gray-500 text-sm mt-2">Future options could include:</p>
                            <ul class="list-disc list-inside text-gray-500 text-sm mt-1">
                                <li>Default alarm sound</li>
                                <li>Snooze duration</li>
                                <li>Theme (Light/Dark)</li>
                                <li>Archive groups</li>
                            </ul>
                        `;
                        openModal('Settings', settingsHtml);
                    });

                    document.getElementById('stop-alarm-btn').addEventListener('click', stopRinging);

                    groupListContainer.addEventListener('click', e => {
                        const groupBtn = e.target.closest('.toggle-group-btn');
                        if (groupBtn) {
                            const groupId = groupBtn.dataset.groupId;
                            const group = appState.groups.find(g => g.id === groupId);
                            if (group) {
                                group.isEnabled = groupBtn.checked;
                                saveState();
                            }
                            return; 
                        }

                        const editGroupBtn = e.target.closest('.edit-group-btn');
                        if (editGroupBtn) {
                            const group = appState.groups.find(g => g.id === editGroupBtn.dataset.groupId);
                            if (group) {
                                showGroupForm(group);
                            }
                            return; 
                        }
                        
                        const groupCard = e.target.closest('.group-card-clickable');
                        if (groupCard) {
                            showGroupAlarms(groupCard.dataset.groupId);
                        }
                    });

                    modalBody.addEventListener('submit', e => {
                        e.preventDefault();
                        if (e.target.id === 'group-form') handleGroupSave(e.target);
                        if (e.target.id === 'alarm-form') handleAlarmSave(e.target);
                        if (e.target.id === 'batch-form') handleBatchSave(e.target);
                    });

                    modalBody.addEventListener('click', e => {
                        const showConfirm = (message, onConfirm) => {
                            const confirmHtml = `
                                <p class="text-gray-700 mb-4">${message}</p>
                                <div class="flex justify-end space-x-2">
                                    <button id="confirm-cancel" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                                    <button id="confirm-ok" class="bg-red-600 text-white px-4 py-2 rounded-lg">Delete</button>
                                </div>
                            `;
                            openModal('Are you sure?', confirmHtml);
                            
                            const confirmOkBtn = document.getElementById('confirm-ok');
                            if (confirmOkBtn) {
                                confirmOkBtn.onclick = onConfirm;
                            }
                            
                            const confirmCancelBtn = document.getElementById('confirm-cancel');
                            if (confirmCancelBtn) {
                                confirmCancelBtn.onclick = () => {
                                    if (window.lastOpenView) window.lastOpenView();
                                    else closeModal();
                                };
                            }
                        };

                        if (e.target.id === 'form-cancel-btn') {
                            closeModal();
                        }

                        if (e.target.id === 'delete-group-btn') {
                            const form = e.target.closest('form');
                            const groupId = form.elements.id.value;
                            const groupToDelete = appState.groups.find(g => g.id === groupId);
                            
                            if (groupToDelete) {
                                window.lastOpenView = () => showGroupForm(groupToDelete);
                                showConfirm('Are you sure you want to delete this group and all its alarms?', () => {
                                    appState.groups = appState.groups.filter(g => g.id !== groupId);
                                    saveState();
                                    closeModal(); 
                                });
                            }
                        }

                        if (e.target.id === 'delete-alarm-btn') {
                            const form = e.target.closest('form');
                            const alarmId = form.elements.id.value;
                            const groupId = form.elements.originalGroupId.value;
                            const group = appState.groups.find(g => g.id === groupId);
                            const alarmToDelete = group ? group.alarms.find(a => a.id === alarmId) : null;

                            if (alarmToDelete) {
                                window.lastOpenView = () => showAlarmForm(alarmToDelete, groupId);
                                showConfirm('Are you sure you want to delete this alarm?', () => {
                                    if (group) {
                                        group.alarms = group.alarms.filter(a => a.id !== alarmId);
                                    }
                                    const lastGroupId = currentGroupId; 
                                    closeModal();
                                    if (lastGroupId) showGroupAlarms(lastGroupId);
                                    else saveState(); 
                                });
                            }
                        }
                        
                        if (e.target.id === 'modal-back-btn' || e.target.closest('#modal-back-btn')) {
                            closeModal(); 
                            renderGroups();
                        }

                        const alarmToggle = e.target.closest('.toggle-alarm-btn');
                        if (alarmToggle) {
                            const alarmId = alarmToggle.dataset.alarmId;
                            const groupId = alarmToggle.dataset.groupId;
                            const group = appState.groups.find(g => g.id === groupId);
                            const alarm = group ? group.alarms.find(a => a.id === alarmId) : null;
                            if (alarm) {
                                alarm.isEnabled = alarmToggle.checked;
                                saveState(); 
                            }
                        }

                        const alarmItem = e.target.closest('.alarm-item-clickable');
                        if (alarmItem && !e.target.closest('.toggle-alarm-btn')) {
                            const alarmId = alarmItem.dataset.alarmId;
                            const group = appState.groups.find(g => g.id === currentGroupId);
                            const alarm = group ? group.alarms.find(a => a.id === alarmId) : null;
                            if (alarm) {
                                showAlarmForm(alarm, group.id);
                            }
                        }

                        const iconBtn = e.target.closest('.icon-select-btn');
                        if (iconBtn) {
                            const iconGrid = iconBtn.closest('#icon-grid');
                            const iconInput = document.getElementById('group-icon-input');
                            
                            if (iconGrid && iconInput) {
                                iconInput.value = iconBtn.dataset.icon;
                                iconGrid.querySelectorAll('.icon-select-btn').forEach(b => {
                                    b.classList.remove('bg-blue-100', 'border-blue-600', 'text-blue-600');
                                    b.classList.add('border-gray-200', 'bg-white', 'text-gray-500', 'hover:bg-gray-50');
                                });
                                iconBtn.classList.add('bg-blue-100', 'border-blue-600', 'text-blue-600');
                                iconBtn.classList.remove('border-gray-200', 'bg-white', 'text-gray-500', 'hover:bg-gray-50');
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error attaching global listeners:", e);
                    const appEl = document.getElementById('app-container');
                    if (appEl) {
                        appEl.innerHTML = '<p class="text-red-500 p-4 font-bold text-lg text-center">A critical error occurred. Please clear your site data in your browser settings and try again.</p>' + appEl.innerHTML;
                    }
                }
            }

            // --- CRUD & FORM LOGIC ---
            function handleGroupSave(form) {
                const formData = new FormData(form);
                const id = formData.get('id') || `g-${Date.now()}`;
                const group = {
                    id: id,
                    name: formData.get('name'),
                    ringtone: formData.get('ringtone'),
                    icon: formData.get('icon') || 'icon-settings',
                    isEnabled: true,
                    alarms: []
                };

                const existingIndex = appState.groups.findIndex(g => g.id === id);
                if (existingIndex > -1) {
                    group.alarms = appState.groups[existingIndex].alarms || []; 
                    group.isEnabled = appState.groups[existingIndex].isEnabled; 
                    appState.groups[existingIndex] = group;
                } else {
                    appState.groups.push(group);
                }
                closeModal();
                saveState(); 
            }

            function handleAlarmSave(form) {
                const formData = new FormData(form);
                const id = formData.get('id') || `a-${Date.now()}`;
                const newGroupId = formData.get('groupId');
                const originalGroupId = formData.get('originalGroupId');
                const selectedDays = Array.from(form.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);

                const alarm = {
                    id: id,
                    time: formData.get('time'),
                    label: formData.get('label') || 'Alarm',
                    days: selectedDays,
                    isEnabled: true,
                    ringtone: formData.get('ringtone') || '', 
                    duration: parseInt(formData.get('duration'), 10) || 60,
                    color: formData.get('color') || '#1f2937'
                };

                if (originalGroupId && originalGroupId !== newGroupId) {
                    const oldGroup = appState.groups.find(g => g.id === originalGroupId);
                    if (oldGroup) {
                        oldGroup.alarms = oldGroup.alarms.filter(a => a.id !== id);
                    }
                }

                const newGroup = appState.groups.find(g => g.id === newGroupId);
                if (!newGroup) {
                    console.error("Could not find group to save alarm to:", newGroupId);
                    closeModal();
                    return;
                }
                
                if (!newGroup.alarms) {
                    newGroup.alarms = [];
                }

                const existingIndex = newGroup.alarms.findIndex(a => a.id === id);
                
                if (existingIndex > -1) {
                    alarm.isEnabled = newGroup.alarms[existingIndex].isEnabled; 
                    newGroup.alarms[existingIndex] = alarm;
                } else {
                    newGroup.alarms.push(alarm);
                }
                
                closeModal(); 
                showGroupAlarms(newGroupId); 
                saveState(); 
            }

            function handleBatchSave(form) {
                const formData = new FormData(form);
                const groupId = formData.get('groupId');
                const start = formData.get('start');
                const end = formData.get('end');
                const interval = parseInt(formData.get('interval'), 10);
                const label = formData.get('label') || 'Batch Alarm';
                const days = Array.from(form.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
                
                const group = appState.groups.find(g => g.id === groupId);
                if (!group || !start || !end || !interval) return;

                // *** THE CRITICAL FIX ***
                // Replaced array destructuring with standard variable assignment for broader browser support.
                const startParts = start.split(':').map(Number);
                let startHour = startParts[0];
                let startMin = startParts[1];
                
                const endParts = end.split(':').map(Number);
                const endHour = endParts[0];
                const endMin = endParts[1];
                // *** END OF FIX ***

                const endTimeInMinutes = endHour * 60 + endMin;
                let currentTimeInMinutes = startHour * 60 + startMin;

                let count = 1;
                while (currentTimeInMinutes <= endTimeInMinutes) {
                    const hour = Math.floor(currentTimeInMinutes / 60).toString().padStart(2, '0');
                    const minute = (currentTimeInMinutes % 60).toString().padStart(2, '0');
                    
                    const alarm = {
                        id: `b-${Date.now()}-${count}`,
                        time: `${hour}:${minute}`,
                        label: `${label} #${count}`,
                        days: days,
                        isEnabled: true,
                        ringtone: '',
                        duration: 60,
                        color: '#1f2937'
                    };
                    
                    if (!group.alarms) group.alarms = [];
                    group.alarms.push(alarm);
                    
                    currentTimeInMinutes += interval;
                    count++;
                }
                
                closeModal();
                showGroupAlarms(groupId); 
                saveState();
            }

            // --- ALARM LOGIC ---
            function checkAlarms() {
                if (currentRingingAlarm) return; 

                const now = new Date();
                const currentDay = DAYS_OF_WEEK[now.getDay()];
                const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                for (const group of appState.groups) {
                    if (!group.isEnabled || !group.alarms) continue;
                    for (const alarm of group.alarms) {
                        if (!alarm.isEnabled || alarm.time !== currentTime) continue;
                        
                        if (!window.lastRungTimes) window.lastRungTimes = {};
                        const lastRungTime = window.lastRungTimes[alarm.id] || 0;
                        
                        if (now.getTime() - lastRungTime < 50000) {
                            continue; 
                        }

                        const isToday = (alarm.days && alarm.days.length === 0) || (alarm.days && alarm.days.includes(currentDay));
                        
                        if (isToday) {
                            window.lastRungTimes[alarm.id] = now.getTime();
                            
                            if (alarm.days.length === 0) {
                                startRinging(alarm, group);
                                alarm.isEnabled = false; 
                                saveState();
                                return;
                            } else {
                                startRinging(alarm, group);
                                return; 
                            }
                        }
                    }
                }
            }

            function startRinging(alarm, group) {
                if (currentRingingAlarm) return;
                
                Tone.start().catch(e => console.error("Tone.start() failed:", e));
                
                currentRingingAlarm = alarm;
                
                document.getElementById('ringing-label').textContent = alarm.label || 'Alarm!';
                document.getElementById('ringing-time').textContent = alarm.time;
                ringingModal.classList.remove('hidden');

                const ringtoneName = alarm.ringtone || group.ringtone || 'Digital';
                const ringtone = RINGTONES.find(r => r.id === ringtoneName);
                
                const synth = new Tone.Synth().toDestination();
                
                if (ringtone && ringtone.id !== 'None') {
                    currentRingtoneLoop = new Tone.Loop(time => {
                        try {
                            ringtone.play(synth);
                        } catch (e) {
                            console.error("Error playing ringtone:", e);
                            stopRinging(); 
                        }
                    }, "1.5s").start(0); 
                    Tone.Transport.start();
                }

                const duration = alarm.duration || 60;
                if (currentStopTimeout) clearTimeout(currentStopTimeout);
                currentStopTimeout = setTimeout(stopRinging, duration * 1000);
            }

            function stopRinging() {
                if (currentRingtoneLoop) {
                    currentRingtoneLoop.stop(0);
                    currentRingtoneLoop.dispose();
                    currentRingtoneLoop = null;
                }
                
                if (Tone.Transport.state === "started") {
                    Tone.Transport.stop();
                }
                
                if (currentStopTimeout) {
                    clearTimeout(currentStopTimeout);
                    currentStopTimeout = null;
                }

                ringingModal.classList.add('hidden');
                currentRingingAlarm = null;
            }

            // --- START THE APP ---
            initialize();
        });
    </script>
</body>
</html>

